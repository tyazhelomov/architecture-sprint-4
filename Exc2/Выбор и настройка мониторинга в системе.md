# Мониторинг

### 1. Мотивация

Учитывая, что у нас запросы проходят довольно долго, а также потенциально происходит потеря данных, необходимо внедрить метрики
для понимания состояния системы в первую очередь, и также поиска узких мест. Также необходимо добавить бизнес метрики
для анализа бизнес показателей системы и получения информации для дальнейшего улучшения.

### 2. Выбор подхода к мониторингу

Для нашей системы наиболее лучшим выбором будет использование метода RED для отслеживания технических метрик.
Учитывая специфику бизнеса и сервисов, метод позволяет оценить состояние системы по основным метрикам:
- Requests Rate — частота запросов,
- Errors — ошибки,
- Duration — длительность.

Для MES будем внедрять метод USE, т.к. он также предоставляет насыщенность, что позволит отслеживать работоспособность компонента.

### 3. Необходимые метрики

- Number of requests (RPS) for internet shop API - для отслеживания трафика интернет-магазина с лейблами юзера и ip адреса
- Number of dead-letter-exchange letters in RabbitMQ - для отслеживания мертвой очереди
- Number of message in flight in RabbitMQ - для понимания объема сообщений, находящихся в обработке
- Number of requests (RPS) for CRM API - для отслеживания количества запросов к CRM
- Number of requests (RPS) for MES API - для отслеживания количества запросов к MES
- Response time (latency) for shop API - для понимания времени ответа
- Response time (latency) for CRM API - для понимания времени ответа
- Response time (latency) for MES API - для понимания времени ответа
- Size of S3 storage - для своевременного увеличения ресурсов
- Size of shop db instance - для своевременного увеличения ресурсов
- Size of MES db instance - для своевременного увеличения ресурсов
- Number of HTTP - для каждого сервиса с лейблом сервиса и http статус кодом
- Kb tranferred (received) for - для понимания объема переданных\полученных данных с лейблами сервиса и направлением потока данных
- Также все основные системные метрики, которые отдают приложения и базы данных(память, цпу и т.д.)

### 4. План действий

- Необходимо поднять и настроить Prometheus
- Необходимо поднять и настроить Prometheus exporter
- Необходимо поднять и настроить ELK стек для сбора и отображения метрик
- Добавление метрик в код сервисов
- Настройка дашбордов
- Настройка алертинга
- Тестирование

### 5. Показатели насыщенности

Показателями насыщенности могут являться:
- Количество одновременных заказов в обработке. Для этого нужно оценить пороговое значение, исходя из исторических данных.
Можно взять пиковое значение, когда происходила деградация системы и вычесть 20% от этого значения.
Возможно использования паттерна Backpressure для снижения нагрузки на систему, а также увеличение количества инстансов, необходимых для стабильной работы.
- Объем памяти или CPU, подходящий к пороговым значениям при обработке заказов. В этом случае заказов может быть немного, но они могут быть объемные,
что может быть сопоставимо со множеством небольших заказов. В этом случае также можно настроить автоматическое увеличение количества инстансов для распределения нагрузки и настроить алертинг.
