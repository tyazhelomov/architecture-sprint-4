# Трейсинг

### 1. Мотивация

Учитывая, что в системе происходит потеря сообщений, а так же зависание запросов, есть смысл внедрения трейсинга.
Трейсинг поможет:
- Найти потерянные сообщения\данные, что позволит повысить скорость доставки и снизит количество негативных отзывов
- Поможет понять в каких системах данные подвисают, чтобы ускорить отклик приложения
- Позволит визуализировать прохождение запроса и построит граф зависимостей для дальнейшей оптимизации архитектуры
- Позволит выявить узкие места приложения, где запрос может находиться дольше обычного и выстроить алертинг на превышение целевых показателей

### 2. Предлагаемое решение

Решение предлагается реализовать с помощью Elastic APM агента и APM сервера, который просто подключается и позволяет снимать метрики трейсинга со всех подключенных приложений и Kibana для их визуализации. Потребует минимум ресурсов, а выполнение интеграции займет 1 неделю, включая тестирование. Также позвляет прокидывать спаны для конкретных функций, что позволит визуализировать узкие места в определенных функциях

```markdown
[Component diagram]()
```

### 3. Компромиссы

Есть возможность добавить трейсинг для всех компонентов, включая MES. Однако, MES - неизведанная система для команды, поэтому на первых этапах будет проблематично оценить точное узкое место, в котором запросы тормозятся. В этом случае компромисов точно не будет, и команде нужно будет поэтапно добавлять спаны на все тяжелые функции, чтобы оценить задержки в выполнении. Учитывая, что проблем с авторизацией нет, то нет смысла прикручивать точечный трейсинг на модуль авторизации, хотя сам сервис, конечно, должен быть покрыт трейсингом.

### 4. Аспекты безопасности

Предполагается, что APM агент будет находиться во внутренней системе, и общаться с APM сервером по внутренней сети, не имея доступ наружу. Таким же подходом планируется реализовать APM сервер и Kibana. В этом случае, будет необходима настройка внутренней сети и VPN с выдачей доступа к админке только доверенным сотрудникам компании. То же самое предполагается реализовать и для остальных внутренних систем мониторинга приложений. То есть извне доступа к сервисам у пользователей не будет. Помимо внутренней сети, у пользователей будет возможность авторизации через логин\пароль и двухфакторную аутентификацию. Будет разделение между пользовательскими и сервисными аккаунтами и настроен регулярный аудит доступов.

### 5. Дополнительное задание

На диаграмме указан дополнительный внешний компонент, в который будут отправляться алерты. Никаких дополнительных систем не потребуется, этим будет заниматься Kibana в связке с Elasticsearch. Необходима настройка алертинга, создание правил и указание целевого адреса отправки алертов.

```markdown
[Component diagram]()
```
